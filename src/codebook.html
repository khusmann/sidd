<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>main/teacher_calibration (20230902.f63be38-dev)</title>
    <link
      href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
      rel="stylesheet"
    />
    <script
      type="text/javascript"
      src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon/build/global/luxon.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        font-family: system-ui, "Segoe UI", "Roboto", "Ubuntu", "Cantarell",
          "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol", "Noto Color Emoji";
      }
      h1 {
        color: hsl(205, 20%, 94%);
      }
      body {
        background-color: #11191f;
        color: hsl(205, 16%, 77%);
      }
      a {
        color: #9eecd9;
      }
      a:hover {
        color: #76c3b0;
      }
      a:visited {
        color: #9eecd9;
      }
      header {
        position: relative;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      footer {
        flex: none;
        margin-top: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      .tabulator {
        background-color: #11191f;
      }
      .tabulator-row .tabulator-cell {
        padding-top: 10px;
        padding-bottom: 10px;
      }
      .bar {
        fill: #69b3a2;
        stroke: hsl(205, 16%, 77%);
      }
      .tabulator-row.tabulator-selected .tabulator-cell {
        background-color: #9eecd9;
      }
      .tabulator-row.tabulator-selected:hover .tabulator-cell {
        background-color: #76c3b0;
      }
      #codebook-table {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        max-height: 100%;
      }
      #bundle-version {
        position: absolute;
        top: -2.5ex;
        right: 0;
      }
      .content {
        display: flex;
        flex-direction: column;
        margin: auto;
        min-width: 960px;
        max-width: 1280px;
        height: 100vh;
        border: 20px solid transparent;
        box-sizing: border-box;
      }
      main {
        flex: 1;
        margin-top: 10px;
        height: 100vh;
        display: block;
      }
      #bundle-description {
        max-height: 10vh;
        margin-top: 10px;
        overflow: hidden;
      }
      .table-wrapper {
        position: relative;
        height: 100%;
      }
      .left {
        float: left;
        width: 55%;
        height: 100%;
        border: 10px solid transparent;
        box-sizing: border-box;
      }
      .right {
        position: relative;
        float: right;
        width: 45%;
        height: 100%;
        border: 10px solid transparent;
        box-sizing: border-box;
      }
      #viewer {
        height: 100%;
        width: 100%;
        fill: hsl(205, 20%, 94%);
        border-style: dashed;
        border-color: hsl(205, 16%, 77%);
        border-width: 2px;
      }
      @media all and (max-width: 1280px) {
        .left,
        .right {
          float: none;
          width: 100%;
          height: 50%;
          border-top-width: 3ex;
        }
      }
      .switch-container {
        position: absolute;
        top: -1.5rem;
        right: 0;
      }
      .switch-container a {
        padding-top: 3px;
        padding-bottom: 3px;
        padding-left: 5px;
        padding-right: 5px;
      }
      .selected-toggle {
        background-color: rgb(91, 91, 91);
        text-decoration: none;
        text-shadow: 0px 0px 1px #9eecd9;
      }
    </style>
  </head>
  <body>
    <div class="content">
      <header>
        <h1 id="bundle-name"></h1>
        <div id="bundle-version"></div>
        <p id="bundle-description"></p>
      </header>
      <main>
        <div class="left">
          <div class="table-wrapper">
            <div id="codebook-table"></div>
          </div>
        </div>
        <div class="right">
          <div class="switch-container">
            Display:
            <a class="selected-toggle" href="#" id="values-button">Values</a>
            <a href="#" id="missingness-button">Missingness</a>
          </div>
          <div id="viewer"></div>
        </div>
      </main>
      <footer>
        <small>Reference codebook rendered by DoIT</small>
      </footer>
    </div>
    <script type="module">
      import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

      // Declare the chart dimensions and margins.
      const width = viewer.offsetWidth;
      const height = viewer.offsetHeight;
      const marginTop = 20;
      const marginRight = 20;
      const marginBottom = 45;
      const marginLeft = 40;

      const renderMissingnessViewer = (curr_var) => {
        const missingness = curr_var.missingness;
        const svg = d3
          .create("svg")
          .attr("width", width)
          .attr("height", height);

        const maxCount = d3.max(missingness, (d) => d.count);

        const x = d3
          .scaleLinear()
          .domain([0, maxCount])
          .range([0, width / 3]);

        const y = d3
          .scaleBand()
          .range([marginTop, height - marginBottom])
          .domain(missingness.map((d) => `${d.label}`))
          .padding(0.1);

        svg
          .append("g")
          .attr("transform", `translate(${width / 3},0)`)
          .call(d3.axisLeft(y));

        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height - 5)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "bottom")
          //          .style("font-size", "10px")
          .text(`${curr_var.name} (missingness)`);

        const bars = svg
          .selectAll("myRect")
          .data(missingness)
          .enter()
          .append("g")
          .attr("class", "bar")
          .attr("transform", `translate(${width / 3 + 5},0)`);

        bars
          .append("rect")
          .attr("x", x(0))
          .attr("y", function (d) {
            return y(`${d.label}`);
          })
          .attr("width", function (d) {
            return x(d.count);
          })
          .attr("height", y.bandwidth());

        bars
          .append("text")
          .text(function (d) {
            return `${d.count} (${d3.format("0.2f")(d.pct * 100)}%)`;
          })
          .attr("y", function (d) {
            return y(`${d.label}`) + y.bandwidth() / 2 + 5;
          })
          .attr("x", function (d) {
            return x(d.count) + 5;
          })
          .style("text-anchor", "left")
          .style("font-size", "10px");

        return svg;
      };

      const renderCodedViewer = (curr_var) => {
        const stats = curr_var.stats;

        const svg = d3
          .create("svg")
          .attr("width", width)
          .attr("height", height);

        const maxCount = d3.max(stats.items, (d) => d.count);

        const x = d3
          .scaleLinear()
          .domain([0, maxCount])
          .range([0, width / 3]);

        const y = d3
          .scaleBand()
          .range([marginTop, height - marginBottom])
          .domain(stats.items.map((d) => `${d.label} (${d.value})`))
          .padding(0.1);

        svg
          .append("g")
          .attr("transform", `translate(${width / 3},0)`)
          .call(d3.axisLeft(y));

        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height - 5)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "bottom")
          //          .style("font-size", "10px")
          .text(curr_var.name);

        const bars = svg
          .selectAll("myRect")
          .data(stats.items)
          .enter()
          .append("g")
          .attr("class", "bar")
          .attr("transform", `translate(${width / 3 + 5},0)`);

        bars
          .append("rect")
          .attr("x", x(0))
          .attr("y", function (d) {
            return y(`${d.label} (${d.value})`);
          })
          .attr("width", function (d) {
            return x(d.count);
          })
          .attr("height", y.bandwidth());

        bars
          .append("text")
          .text(function (d) {
            return `${d.count} (${d3.format("0.2f")(d.pct * 100)}%)`;
          })
          .attr("y", function (d) {
            return y(`${d.label} (${d.value})`) + y.bandwidth() / 2 + 5;
          })
          .attr("x", function (d) {
            return x(d.count) + 5;
          })
          .style("text-anchor", "left")
          .style("font-size", "10px");

        return svg;
      };

      const renderNumericViewer = (curr_var) => {
        const stats = curr_var.stats;

        const x = d3
          .scaleLinear()
          .domain([stats.min, stats.max])
          .range([marginLeft, width - marginRight]);

        const maxCount = d3.max(stats.freqs, (d) => d.count);

        const y = d3
          .scaleLinear()
          .domain([0, maxCount])
          .range([height - marginBottom, marginTop + 30]);

        // Create the SVG container.
        const svg = d3
          .create("svg")
          .attr("width", width)
          .attr("height", height);

        const formatted_mean = d3.format(".1f")(stats.mean);
        const formatted_sd = d3.format(".1f")(stats.sd);
        const fomatted_min = d3.format(".1f")(stats.min);
        const formatted_max = d3.format(".1f")(stats.max);

        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", marginTop + 10)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "top")
          //          .style("font-size", "10px")
          .text(`μ = ${formatted_mean}, σ = ${formatted_sd}`);

        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height - 5)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "bottom")
          //          .style("font-size", "10px")
          .text(curr_var.name);

        svg
          .append("text")
          .attr("x", marginLeft)
          .attr("y", marginTop + 10)
          .attr("text-anchor", "start")
          .attr("dominant-baseline", "top")
          //          .style("font-size", "10px")
          .text(`min = ${fomatted_min}`);

        svg
          .append("text")
          .attr("x", width - marginRight)
          .attr("y", marginTop + 10)
          .attr("text-anchor", "end")
          .attr("dominant-baseline", "top")
          //          .style("font-size", "10px")
          .text(`max = ${formatted_max}`);

        // Add the x-axis.
        svg
          .append("g")
          .attr("transform", `translate(0,${height - marginBottom})`)
          .call(d3.axisBottom(x));

        // Add the y-axis.
        svg
          .append("g")
          .attr("transform", `translate(${marginLeft},0)`)
          .call(d3.axisLeft(y));

        const bars = svg
          .selectAll("myRect")
          .data(stats.freqs)
          .enter()
          .append("g")
          .attr("class", "bar");

        bars
          .append("rect")
          .attr("x", function (d) {
            return x(d.min);
          })
          .attr("y", function (d) {
            return y(d.count);
          })
          .attr("width", function (d) {
            return x(d.max) - x(d.min);
          })
          .attr("height", function (d) {
            return y(0) - y(d.count);
          });

        /*
        bars
          .append("text")
          .text(function (d) {
            return d.count;
          })
          .attr("x", function (d) {
            return x(d.bin) + binWidth / 2 + 5;
          })
          .attr("y", function (d) {
            return y(d.count) - 5;
          })
          .style("text-anchor", "middle")
          .style("font-size", "10px");
        */
        return svg;
      };

      const renderPlaceholderViewer = (message) => {
        const svg = d3
          .create("svg")
          .attr("width", width)
          .attr("height", height);

        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height / 2)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .text(message);

        return svg;
      };

      const renderViewer = (curr_var) => {
        if (curr_var && curr_var.stats) {
          const stype = curr_var.stats.stype;
          if (
            stype === "categorical" ||
            stype === "ordinal" ||
            stype === "multiselect"
          ) {
            return renderCodedViewer(curr_var);
          }
          if (stype === "real" || stype == "integer") {
            return renderNumericViewer(curr_var);
          }
        }
        return renderPlaceholderViewer(
          "Select a numeric or coded variable to view its distribution."
        );
      };

      const renderMissingness = (curr_var) => {
        if (curr_var) {
          return renderMissingnessViewer(curr_var);
        }
        return renderPlaceholderViewer(
          "Select a variable to view its missingness distribution"
        );
      };

      window.setViewer = (curr_var = null, display_state) => {
        const render =
          display_state === "missingness"
            ? renderMissingness(curr_var).node()
            : renderViewer(curr_var).node();

        // Append the SVG element.
        if (viewer.firstChild) {
          viewer.removeChild(viewer.firstChild);
        }
        viewer.append(render);
      };

      setViewer();
    </script>

    <script type="text/javascript">
      //sample data
      var id_counter = 0;

      const fakeDescriptions = [
        "This is a short variable description",
        "This is a long variable description. This is a long variable description. This is a long variable description. This is a long variable description.",
      ];

      function getRandom(array) {
        return array[Math.floor(Math.random() * array.length)];
      }

      function fakeTextVariable(name) {
        groups = name.split("_");
        return {
          id: id_counter++,
          name,
          description: getRandom(fakeDescriptions),
          type: "text",
          num_valid: 100,
          num_missing: 20,
          group: groups[0],
          stats: {
            stype: "text",
          },
          missingness: [
            {
              label: "UNKNOWN_MISSING_REASON",
              count: 100,
              pct: 0.5,
            },
            {
              label: "ITEM_NOT_DISPLAYED",
              count: 20,
              pct: 0.1,
            },
          ],
        };
      }

      function fakeCategoricalVariable(name) {
        groups = name.split("_");
        return {
          id: id_counter++,
          name,
          description: getRandom(fakeDescriptions),
          type: "categorical",
          num_valid: 100,
          num_missing: 20,
          group: groups[0],
          missingness: [
            {
              label: "UNKNOWN_MISSING_REASON",
              count: 100,
              pct: 0.1,
            },
            {
              label: "ITEM_NOT_DISPLAYED",
              count: 20,
              pct: 0.1,
            },
          ],
          stats: {
            stype: "categorical",
            items: [
              {
                label: "MALE",
                value: 0,
                text: "Male",
                count: 100,
                pct: 0.1,
              },
              {
                label: "FEMALE",
                value: 1,
                text: "Female",
                count: 200,
                pct: 0.1,
              },
              {
                label: "TRANSGENDER",
                value: 2,
                text: "Transgender",
                count: 20,
                pct: 0.1,
              },
              {
                label: "PREFER_NO_ANSWER",
                value: 3,
                text: "Prefer not to answer",
                count: 1,
                pct: 0.1,
              },
            ],
          },
        };
      }

      function fakeContinuousVariable(name) {
        groups = name.split("_");
        return {
          id: id_counter++,
          name,
          description: getRandom(fakeDescriptions),
          type: "real",
          num_valid: 100,
          num_missing: 20,
          group: groups[0],
          missingness: [
            {
              label: "UNKNOWN_MISSING_REASON",
              count: 100,
              pct: 0.1,
            },
            {
              label: "ITEM_NOT_DISPLAYED",
              count: 20,
              pct: 0.1,
            },
          ],
          stats: {
            stype: "real",
            min: 0,
            max: 100,
            mean: 50,
            sd: 10,
            freqs: [
              {
                min: 0,
                max: 10,
                count: 1,
              },
              {
                min: 10,
                max: 20,
                count: 2,
              },
              {
                min: 20,
                max: 30,
                count: 3,
              },
              {
                min: 30,
                max: 40,
                count: 4,
              },
              {
                min: 40,
                max: 50,
                count: 5,
              },
              {
                min: 50,
                max: 60,
                count: 6,
              },
              {
                min: 60,
                max: 70,
                count: 5,
              },
              {
                min: 70,
                max: 80,
                count: 4,
              },
              {
                min: 80,
                max: 90,
                count: 9,
              },
              {
                min: 90,
                max: 100,
                count: 10,
              },
            ],
          },
        };
      }

      const testdata = {
        bundle: {
          name: "main/teacher_calibration",
          package_version: "20230902.f63be38-dev",
          description:
            "Sample data bundle for ACES. Blah blah blah Blah blah blah Blah blah blah Blah blah blah Blah blah blah Blah blah blah Blah blah blah Blah blah blah Blah blah blah Blah blah blah ",
        },
        tabledata: [
          fakeTextVariable("id_child"),
          fakeCategoricalVariable("child_gender"),
          fakeContinuousVariable("child_age"),
          fakeContinuousVariable("child_height"),
          fakeTextVariable("child_skill"),
          fakeCategoricalVariable("child_grade"),
        ],
      };
    </script>

    <script type="text/javascript">
      const dataJson = "{{}}";

      function get_data() {
        try {
          return JSON.parse(dataJson);
        } catch (e) {
          return testdata;
        }
      }

      const alldata = get_data();

      const bundledata = alldata.bundle;

      const bundle_mappings = {
        "bundle-name": bundledata.name,
        "bundle-version": `(${bundledata.package_version})`,
        "bundle-description": bundledata.description,
      };

      Object.keys(bundle_mappings).forEach((key) => {
        document.getElementById(key).innerHTML = bundle_mappings[key];
      });

      const uniqTypes = Array.from(
        new Set(alldata.tabledata.map((d) => d.type))
      );

      const tabledata = alldata.tabledata;
      const table = new Tabulator("#codebook-table", {
        data: tabledata,
        layout: "fitColumns",
        groupBy: ["group"],
        groupStartOpen: false,
        selectable: 1,
        rowSelectedBackground: "#69b3a2",
        rowSelectedBackgroundHover: "#69b3a2",
        columns: [
          //Define Table Columns
          {
            title: "Variable",
            field: "name",
            sorter: "string",
            vertAlign: "middle",
            headerFilter: "input",
          },
          {
            title: "Type",
            field: "type",
            sorter: "string",
            hozAlign: "center",
            vertAlign: "middle",
            width: 130,
            headerFilter: "list",
            headerFilterFunc: "=",
            headerFilterParams: {
              values: uniqTypes,
            },
          },
          {
            title: "Description",
            field: "description",
            sorter: "string",
            headerSort: false,
            vertAlign: "middle",
            widthGrow: 1,
            formatter: "textarea",
            headerFilter: "input",
          },
          {
            title: "Valid",
            field: "num_valid",
            sorter: "number",
            hozAlign: "center",
            vertAlign: "middle",
            width: 100,
          },
          {
            title: "NA",
            field: "num_missing",
            sorter: "number",
            hozAlign: "center",
            vertAlign: "middle",
            width: 100,
          },
        ],
      });

      var display_state = "values";
      var curr_row = null;

      table.on("rowSelected", function (row) {
        curr_row = row.getData();
        setViewer(curr_row, display_state);
      });
      table.on("rowMouseEnter", function (e, row) {
        if (table.getSelectedData().length === 0) {
          curr_row = row.getData();
          setViewer(curr_row, display_state);
        }
      });

      const values_button = document.getElementById("values-button");
      const missingness_button = document.getElementById("missingness-button");

      function set_state(state) {
        display_state = state;
        if (display_state === "values") {
          values_button.classList.add("selected-toggle");
          missingness_button.classList.remove("selected-toggle");
        } else {
          missingness_button.classList.add("selected-toggle");
          values_button.classList.remove("selected-toggle");
        }
        setViewer(curr_row, display_state);
      }

      function toggle_state() {
        if (display_state === "values") {
          set_state("missingness");
        } else {
          set_state("values");
        }
      }

      values_button.onclick = function () {
        set_state("values");
      };

      missingness_button.onclick = function () {
        set_state("missingness");
      };

      function toggle_listener(event) {
        var name = event.key;
        var code = event.code;
        // if it is the left or right shift key, toggle the state
        if (code === "ShiftLeft" || code === "ShiftRight") {
          toggle_state();
        }
      }

      document.addEventListener("keydown", toggle_listener, false);
      document.addEventListener("keyup", toggle_listener, false);
    </script>
  </body>
</html>
